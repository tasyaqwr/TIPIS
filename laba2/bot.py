"""
–ü—Ä–æ—Å—Ç–µ–π—à–∏–π Telegram –±–æ—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã—Ö —Ä–∞–±–æ—Ç
"""

import asyncio
import os
import tempfile
from pathlib import Path

from aiogram import Bot, Dispatcher, F
from aiogram.types import Message, InlineKeyboardMarkup, InlineKeyboardButton
from aiogram.filters import CommandStart, Command
from aiogram.enums import ParseMode
from aiogram.client.default import DefaultBotProperties

from dotenv import load_dotenv
from openai import OpenAI

from file_utils import extract_docx, extract_pdf, extract_txt


# –ó–∞–≥—Ä—É–∑–∫–∞ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö –æ–∫—Ä—É–∂–µ–Ω–∏—è
load_dotenv()

BOT_TOKEN = os.getenv("TELEGRAM_BOT_TOKEN")
OPENROUTER_KEY = os.getenv("OPENROUTER_API_KEY")

if not BOT_TOKEN or not OPENROUTER_KEY:
    print("–î–æ–±–∞–≤—å—Ç–µ —Ç–æ–∫–µ–Ω—ã –≤ .env —Ñ–∞–π–ª!")
    exit(1)

# –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è
bot = Bot(
    token=BOT_TOKEN, 
    default=DefaultBotProperties(parse_mode=ParseMode.HTML)
)
dp = Dispatcher()

# OpenRouter –∫–ª–∏–µ–Ω—Ç
openrouter = OpenAI(
    api_key=OPENROUTER_KEY,
    base_url="https://openrouter.ai/api/v1"
)


AI_MODEL = "mistralai/devstral-small-2505:free"

# –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã
SUPPORTED_FORMATS = ['.pdf', '.docx', '.txt']
MAX_FILE_SIZE = 20 * 1024 * 1024  # 20 –ú–ë

def get_main_keyboard():
    """–ì–ª–∞–≤–Ω–∞—è –∫–ª–∞–≤–∏–∞—Ç—É—Ä–∞"""
    return InlineKeyboardMarkup(inline_keyboard=[
        [InlineKeyboardButton(text="ü§ñ –¢–µ–∫—É—â–∞—è –º–æ–¥–µ–ª—å", callback_data="current_model")],
        [InlineKeyboardButton(text="‚ùì –ü–æ–º–æ—â—å", callback_data="help")]
    ])

@dp.message(CommandStart())
async def start_command(message: Message):
    """–ö–æ–º–∞–Ω–¥–∞ /start"""
    await message.answer(
        f"üéì <b>–ü—Ä–∏–≤–µ—Ç, {message.from_user.first_name}!</b>\n\n"
        "–Ø –ø—Ä–æ–≤–µ—Ä—è—é –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã–µ —Ä–∞–±–æ—Ç—ã —Å –ø–æ–º–æ—â—å—é –ò–ò.\n\n"
        f"ü§ñ <b>–¢–µ–∫—É—â–∞—è –º–æ–¥–µ–ª—å:</b>\n<code>{AI_MODEL}</code>\n\n"
        "üìÑ <b>–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è:</b>\n"
        "–ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å –º–Ω–µ —Ñ–∞–π–ª —Å —Ä–∞–±–æ—Ç–æ–π!\n\n"
        "üí° <b>–°–º–µ–Ω–∏—Ç—å –º–æ–¥–µ–ª—å:</b>\n"
        "–ò–∑–º–µ–Ω–∏ –ø–µ—Ä–µ–º–µ–Ω–Ω—É—é AI_MODEL –≤ –∫–æ–¥–µ –±–æ—Ç–∞\n\n"
        "üìÅ <b>–ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é:</b> PDF, DOCX, TXT —Ñ–∞–π–ª—ã (–¥–æ 20 –ú–ë)",
        reply_markup=get_main_keyboard()
    )

@dp.message(Command("help"))
async def help_command(message: Message):
    """–ö–æ–º–∞–Ω–¥–∞ /help"""
    await message.answer(
        "üìñ <b>–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è –±–æ—Ç–æ–º:</b>\n\n"
        "1Ô∏è‚É£ –û—Ç–ø—Ä–∞–≤—å –º–Ω–µ —Ñ–∞–π–ª —Å –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–π —Ä–∞–±–æ—Ç–æ–π\n"
        "2Ô∏è‚É£ –ñ–¥–∏ –ø—Ä–æ–≤–µ—Ä–∫—É –æ—Ç –ò–ò (1-2 –º–∏–Ω—É—Ç—ã)\n"
        "3Ô∏è‚É£ –ü–æ–ª—É—á–∏ –¥–µ—Ç–∞–ª—å–Ω—É—é –æ—Ü–µ–Ω–∫—É\n\n"
        "<b>ü§ñ –¢–µ–∫—É—â–∞—è –º–æ–¥–µ–ª—å:</b>\n"
        f"<code>{AI_MODEL}</code>\n\n"
        "<b>üìÅ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã:</b>\n"
        "‚Ä¢ PDF (–¥–æ 20 –ú–ë)\n"
        "‚Ä¢ DOCX (Microsoft Word)\n"
        "‚Ä¢ TXT (—Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Ñ–∞–π–ª—ã)\n\n"
        "<b>üìä –ß—Ç–æ –ø—Ä–æ–≤–µ—Ä—è–µ—Ç—Å—è:</b>\n"
        "‚Ä¢ –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–¥–∞ –∏ —Ä–µ—à–µ–Ω–∏—è\n"
        "‚Ä¢ –ü–æ–ª–Ω–æ—Ç–∞ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏\n" 
        "‚Ä¢ –ü—Ä–∞–≤–∏–ª—å–Ω–æ—Å—Ç—å –≤—ã–≤–æ–¥–æ–≤\n"
        "‚Ä¢ –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ —Ä–∞–±–æ—Ç—ã\n\n"
        "<b>üí° –†–µ–∑—É–ª—å—Ç–∞—Ç:</b> –û—Ü–µ–Ω–∫–∞ –∏–∑ 100 –±–∞–ª–ª–æ–≤ + —Ä–µ–∫–æ–º–µ–Ω–¥–∞—Ü–∏–∏",
        reply_markup=get_main_keyboard()
    )

@dp.message(Command("model"))
async def model_info_command(message: Message):
    """–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ —Ç–µ–∫—É—â–µ–π –º–æ–¥–µ–ª–∏"""
    await message.answer(
        f"ü§ñ <b>–¢–µ–∫—É—â–∞—è –º–æ–¥–µ–ª—å –ò–ò:</b>\n\n"
        f"<code>{AI_MODEL}</code>\n\n",
        reply_markup=get_main_keyboard()
    )

@dp.callback_query(F.data == "help")
async def help_callback(callback):
    """–ü–æ–º–æ—â—å —á–µ—Ä–µ–∑ callback"""
    await help_command(callback.message)

@dp.callback_query(F.data == "current_model")
async def current_model_callback(callback):
    """–ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –º–æ–¥–µ–ª–∏ —á–µ—Ä–µ–∑ callback"""
    await model_info_command(callback.message)

@dp.message(F.text & ~F.text.startswith('/'))
async def handle_text(message: Message):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ç–µ–∫—Å—Ç–æ–≤—ã—Ö —Å–æ–æ–±—â–µ–Ω–∏–π"""
    await message.answer(
        "üìÑ <b>–û—Ç–ø—Ä–∞–≤—å —Ñ–∞–π–ª –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏!</b>\n\n"
        "–Ø –Ω–µ –∞–Ω–∞–ª–∏–∑–∏—Ä—É—é —Ç–µ–∫—Å—Ç–æ–≤—ã–µ —Å–æ–æ–±—â–µ–Ω–∏—è.\n"
        "–ü—Ä–æ—Å—Ç–æ –ø—Ä–∏–∫—Ä–µ–ø–∏ —Ñ–∞–π–ª —Å –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω–æ–π —Ä–∞–±–æ—Ç–æ–π.\n\n"
        f"ü§ñ <b>–ú–æ–¥–µ–ª—å:</b> {AI_MODEL}\n"
        "üìÅ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é: PDF, DOCX, TXT",
        reply_markup=get_main_keyboard()
    )

@dp.message(F.document)
async def handle_document(message: Message):
    """–û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–∞–π–ª–∞"""
    document = message.document
    file_name = document.file_name
    file_size = document.file_size
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–∑–º–µ—Ä–∞
    if file_size > MAX_FILE_SIZE:
        await message.answer(
            f"‚ùå <b>–§–∞–π–ª —Å–ª–∏—à–∫–æ–º –±–æ–ª—å—à–æ–π!</b>\n\n"
            f"üìè –†–∞–∑–º–µ—Ä —Ñ–∞–π–ª–∞: {file_size / 1024 / 1024:.1f} –ú–ë\n"
            f"üìè –ú–∞–∫—Å–∏–º—É–º: {MAX_FILE_SIZE / 1024 / 1024} –ú–ë\n\n"
            f"–ü–æ–ø—Ä–æ–±—É–π —Å–∂–∞—Ç—å —Ñ–∞–π–ª –∏–ª–∏ –≤—ã–±—Ä–∞—Ç—å –¥—Ä—É–≥–æ–π.",
            reply_markup=get_main_keyboard()
        )
        return
    
    # –ü—Ä–æ–≤–µ—Ä–∫–∞ —Ñ–æ—Ä–º–∞—Ç–∞
    file_ext = Path(file_name).suffix.lower()
    if file_ext not in SUPPORTED_FORMATS:
        await message.answer(
            f"‚ùå <b>–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç!</b>\n\n"
            f"üìÑ –¢–≤–æ–π —Ñ–∞–π–ª: <code>{file_ext}</code>\n"
            f"üìÅ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞—é: <code>{', '.join(SUPPORTED_FORMATS)}</code>\n\n"
            f"–ü—Ä–µ–æ–±—Ä–∞–∑—É–π —Ñ–∞–π–ª –≤ –ø–æ–¥—Ö–æ–¥—è—â–∏–π —Ñ–æ—Ä–º–∞—Ç.",
            reply_markup=get_main_keyboard()
        )
        return
    
    # –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Å—Ç–∞—Ç—É—Å –æ–±—Ä–∞–±–æ—Ç–∫–∏
    status_msg = await message.answer(
        "‚è≥ <b>–ü—Ä–æ–≤–µ—Ä—è—é —Ä–∞–±–æ—Ç—É...</b>\n\n"
        f"ü§ñ <b>–ú–æ–¥–µ–ª—å:</b> {AI_MODEL}\n"
        "üîÑ –ó–∞–≥—Ä—É–∂–∞—é —Ñ–∞–π–ª\n"
        "‚è≥ –ò–∑–≤–ª–µ–∫–∞—é —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ\n"
        "‚è≥ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Å –ø–æ–º–æ—â—å—é –ò–ò\n\n"
        "<i>–û–±—ã—á–Ω–æ –∑–∞–Ω–∏–º–∞–µ—Ç 1-2 –º–∏–Ω—É—Ç—ã</i>"
    )
    
    temp_path = None
    
    try:
        # –ó–∞–≥—Ä—É–∂–∞–µ–º —Ñ–∞–π–ª
        file = await bot.get_file(document.file_id)
        
        # –°–æ–∑–¥–∞–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
        with tempfile.NamedTemporaryFile(suffix=file_ext, delete=False) as tmp_file:
            await bot.download_file(file.file_path, tmp_file.name)
            temp_path = tmp_file.name
        
        await status_msg.edit_text(
            "‚è≥ <b>–ü—Ä–æ–≤–µ—Ä—è—é —Ä–∞–±–æ—Ç—É...</b>\n\n"
            f"ü§ñ <b>–ú–æ–¥–µ–ª—å:</b> {AI_MODEL}\n"
            "‚úÖ –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω\n"
            "üîÑ –ò–∑–≤–ª–µ–∫–∞—é —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ\n"
            "‚è≥ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Å –ø–æ–º–æ—â—å—é –ò–ò"
        )
        
        # –ò–∑–≤–ª–µ–∫–∞–µ–º —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ç–∏–ø–∞ —Ñ–∞–π–ª–∞
        if file_ext == '.txt':
            content = await extract_txt(temp_path)
        elif file_ext == '.docx':
            content = await extract_docx(temp_path)
        elif file_ext == '.pdf':
            content = await extract_pdf(temp_path)
        else:
            raise Exception("–ù–µ–ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–π —Ñ–æ—Ä–º–∞—Ç")
        
        # –ü—Ä–æ–≤–µ—Ä—è–µ–º, —á—Ç–æ —Å–æ–¥–µ—Ä–∂–∏–º–æ–µ –Ω–µ –ø—É—Å—Ç–æ–µ
        if not content.strip():
            raise Exception("–§–∞–π–ª –ø—É—Å—Ç –∏–ª–∏ –Ω–µ —Å–æ–¥–µ—Ä–∂–∏—Ç —á–∏—Ç–∞–µ–º–æ–≥–æ —Ç–µ–∫—Å—Ç–∞")
        
        await status_msg.edit_text(
            "‚è≥ <b>–ü—Ä–æ–≤–µ—Ä—è—é —Ä–∞–±–æ—Ç—É...</b>\n\n"
            f"ü§ñ <b>–ú–æ–¥–µ–ª—å:</b> {AI_MODEL}\n"
            "‚úÖ –§–∞–π–ª –∑–∞–≥—Ä—É–∂–µ–Ω\n"
            "‚úÖ –°–æ–¥–µ—Ä–∂–∏–º–æ–µ –∏–∑–≤–ª–µ—á–µ–Ω–æ\n"
            "üîÑ –ê–Ω–∞–ª–∏–∑–∏—Ä—É—é —Å –ø–æ–º–æ—â—å—é –ò–ò\n\n"
            "<i>–ò–ò –∞–Ω–∞–ª–∏–∑–∏—Ä—É–µ—Ç —Ä–∞–±–æ—Ç—É...</i>"
        )
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –Ω–∞ –ø—Ä–æ–≤–µ—Ä–∫—É
        result = await check_with_ai(content)
        
        # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
        if temp_path:
            os.unlink(temp_path)
        
        # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—é –æ —Ñ–∞–π–ª–µ
        await status_msg.edit_text(
            "‚úÖ <b>–ü—Ä–æ–≤–µ—Ä–∫–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–∞!</b>\n\n"
            f"üìÑ <b>–§–∞–π–ª:</b> <code>{file_name}</code>\n"
            f"üìä <b>–†–∞–∑–º–µ—Ä:</b> {file_size / 1024:.1f} –ö–ë\n"
            f"üìù <b>–°–∏–º–≤–æ–ª–æ–≤:</b> {len(content):,}\n"
            f"ü§ñ <b>–ú–æ–¥–µ–ª—å:</b> {AI_MODEL}"
        )
        
        # –†–∞–∑–±–∏–≤–∞–µ–º –¥–ª–∏–Ω–Ω—ã–π —Ä–µ–∑—É–ª—å—Ç–∞—Ç –Ω–∞ —á–∞—Å—Ç–∏ (Telegram –æ–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ 4096 —Å–∏–º–≤–æ–ª–æ–≤)
        if len(result) > 4000:
            parts = [result[i:i+4000] for i in range(0, len(result), 4000)]
            for i, part in enumerate(parts):
                if i == 0:
                    await message.answer(f"üìã <b>–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏:</b>\n\n{part}")
                else:
                    await message.answer(f"üìã <b>–ü—Ä–æ–¥–æ–ª–∂–µ–Ω–∏–µ ({i+1}):</b>\n\n{part}")
        else:
            await message.answer(f"üìã <b>–†–µ–∑—É–ª—å—Ç–∞—Ç –ø—Ä–æ–≤–µ—Ä–∫–∏:</b>\n\n{result}")
        
        # –ü—Ä–µ–¥–ª–∞–≥–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∏—Ç—å –µ—â–µ —Ñ–∞–π–ª
        await message.answer(
            "üéâ <b>–ì–æ—Ç–æ–≤–æ!</b>\n\n"
            "–ú–æ–∂–µ—à—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å –µ—â–µ –æ–¥–∏–Ω —Ñ–∞–π–ª –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ üìÑ",
            reply_markup=get_main_keyboard()
        )
        
    except Exception as e:
        # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
        if temp_path:
            try:
                os.unlink(temp_path)
            except:
                pass
        
        await status_msg.edit_text(
            f"‚ùå <b>–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞–±–æ—Ç–∫–µ —Ñ–∞–π–ª–∞:</b>\n\n"
            f"<code>{str(e)}</code>\n\n"
            f"–ü–æ–ø—Ä–æ–±—É–π –µ—â–µ —Ä–∞–∑ –∏–ª–∏ –≤—ã–±–µ—Ä–∏ –¥—Ä—É–≥–æ–π —Ñ–∞–π–ª.",
            reply_markup=get_main_keyboard()
        )

async def check_with_ai(content: str) -> str:
    """–ü—Ä–æ–≤–µ—Ä–∫–∞ —Ä–∞–±–æ—Ç—ã —á–µ—Ä–µ–∑ OpenRouter"""
    
    prompt = f"""
–¢—ã –ª—É—á—à–∏–π –ø—Ä–µ–ø–æ–¥–∞–≤–∞—Ç–µ–ª—å –ø–æ –∏–Ω—Ñ–æ—Ä–º–∞—Ç–∏–∫–µ. –ü—Ä–æ–∞–Ω–∞–ª–∏–∑–∏—Ä—É–π —ç—Ç—É –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—É—é —Ä–∞–±–æ—Ç—É —Å—Ç—É–¥–µ–Ω—Ç–∞ –∏ –¥–∞–π —Ä–∞–∑–≤–µ—Ä–Ω—É—Ç—É—é –æ—Ü–µ–Ω–∫—É.

–ö–†–ò–¢–ï–†–ò–ò –û–¶–ï–ù–ö–ò (–º–∞–∫—Å–∏–º—É–º 100 –±–∞–ª–ª–æ–≤):

üéØ 1. –¢–ï–•–ù–ò–ß–ï–°–ö–ê–Ø –†–ï–ê–õ–ò–ó–ê–¶–ò–Ø (0-35 –±–∞–ª–ª–æ–≤)
   ‚Ä¢ –ö–æ—Ä—Ä–µ–∫—Ç–Ω–æ—Å—Ç—å –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤ –∏ –ª–æ–≥–∏–∫–∏
   ‚Ä¢ –û–ø—Ç–∏–º–∞–ª—å–Ω–æ—Å—Ç—å –∏ —ç—Ñ—Ñ–µ–∫—Ç–∏–≤–Ω–æ—Å—Ç—å —Ä–µ—à–µ–Ω–∏–π
   ‚Ä¢ –û—Ç—Å—É—Ç—Å—Ç–≤–∏–µ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–∏—Ö –æ—à–∏–±–æ–∫
   ‚Ä¢ –ö–∞—á–µ—Å—Ç–≤–æ –∞—Ä—Ö–∏—Ç–µ–∫—Ç—É—Ä—ã –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä—ã –∫–æ–¥–∞

üìã 2. –í–´–ü–û–õ–ù–ï–ù–ò–ï –¢–†–ï–ë–û–í–ê–ù–ò–ô (0-30 –±–∞–ª–ª–æ–≤)
   ‚Ä¢ –ü–æ–ª–Ω–æ—Ç–∞ —Ä–µ–∞–ª–∏–∑–∞—Ü–∏–∏ –≤—Å–µ—Ö –ø—É–Ω–∫—Ç–æ–≤ –∑–∞–¥–∞–Ω–∏—è
   ‚Ä¢ –°–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ —Ç–µ—Ö–Ω–∏—á–µ—Å–∫–æ–º—É –∑–∞–¥–∞–Ω–∏—é
   ‚Ä¢ –†–µ—à–µ–Ω–∏–µ –¥–æ–ø–æ–ª–Ω–∏—Ç–µ–ª—å–Ω—ã—Ö –∑–∞–¥–∞—á (–µ—Å–ª–∏ –ø—Ä–µ–¥—É—Å–º–æ—Ç—Ä–µ–Ω—ã)
   ‚Ä¢ –ó–∞–≤–µ—Ä—à–µ–Ω–Ω–æ—Å—Ç—å —Ä–∞–±–æ—Ç—ã

üìù 3. –î–û–ö–£–ú–ï–ù–¢–ò–†–û–í–ê–ù–ò–ï (0-20 –±–∞–ª–ª–æ–≤)
   ‚Ä¢ –ö–∞—á–µ—Å—Ç–≤–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –≤ –∫–æ–¥–µ
   ‚Ä¢ –û–ø–∏—Å–∞–Ω–∏–µ –∞–ª–≥–æ—Ä–∏—Ç–º–æ–≤ –∏ –º–µ—Ç–æ–¥–æ–≤
   ‚Ä¢ –ù–∞–ª–∏—á–∏–µ –∏ –ø–æ–ª–Ω–æ—Ç–∞ –ø–æ—è—Å–Ω–∏—Ç–µ–ª—å–Ω–æ–π –∑–∞–ø–∏—Å–∫–∏
   ‚Ä¢ –ß–∏—Ç–∞–µ–º–æ—Å—Ç—å –∏ –ø–æ–Ω—è—Ç–Ω–æ—Å—Ç—å –∫–æ–¥–∞

‚ú® 4. –ö–ê–ß–ï–°–¢–í–û –û–§–û–†–ú–õ–ï–ù–ò–Ø (0-15 –±–∞–ª–ª–æ–≤)
   ‚Ä¢ –°–æ–±–ª—é–¥–µ–Ω–∏–µ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–æ–≤ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è
   ‚Ä¢ –°—Ç—Ä—É–∫—Ç—É—Ä–∏—Ä–æ–≤–∞–Ω–Ω–æ—Å—Ç—å –ø—Ä–æ–µ–∫—Ç–∞
   ‚Ä¢ –ê–∫–∫—É—Ä–∞—Ç–Ω–æ—Å—Ç—å –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∏—è —Ä–∞–±–æ—Ç—ã
   ‚Ä¢ –§–æ—Ä–º–∞—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ –∫–æ–¥–∞ –∏ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü–∏–∏

–°–û–î–ï–†–ñ–ò–ú–û–ï –†–ê–ë–û–¢–´:
{content}
–§–û–†–ú–ê–¢ –û–¢–í–ï–¢–ê –î–û–õ–ñ–ï–ù –ë–´–¢–¨ –°–õ–ï–î–£–Æ–©–ò–ú:

1. **–ö–†–ê–¢–ö–û–ï –†–ï–ó–Æ–ú–ï**
   - –û—Å–Ω–æ–≤–Ω–∞—è —Ç–µ–º–∞ –∏ —Ü–µ–ª—å —Ä–∞–±–æ—Ç—ã
   - –û–±—â–µ–µ –≤–ø–µ—á–∞—Ç–ª–µ–Ω–∏–µ

2. **–î–ï–¢–ê–õ–¨–ù–´–ô –ê–ù–ê–õ–ò–ó –ü–û –ö–†–ò–¢–ï–†–ò–Ø–ú**
   - üéØ –¢–µ—Ö–Ω–∏—á–µ—Å–∫–∞—è —Ä–µ–∞–ª–∏–∑–∞—Ü–∏—è: X/35 (–∫–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ –∑–∞–º–µ—á–∞–Ω–∏—è –∏ –ø–æ—Ö–≤–∞–ª—ã)
   - üìã –í—ã–ø–æ–ª–Ω–µ–Ω–∏–µ —Ç—Ä–µ–±–æ–≤–∞–Ω–∏–π: Y/30 (—Å–æ–æ—Ç–≤–µ—Ç—Å—Ç–≤–∏–µ –¢–ó)
   - üìù –î–æ–∫—É–º–µ–Ω—Ç–∏—Ä–æ–≤–∞–Ω–∏–µ: Z/20 (–∫–∞—á–µ—Å—Ç–≤–æ –∫–æ–º–º–µ–Ω—Ç–∞—Ä–∏–µ–≤ –∏ –æ–ø–∏—Å–∞–Ω–∏–π)
   - ‚ú® –ö–∞—á–µ—Å—Ç–≤–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏—è: W/15 (–≤–Ω–µ—à–Ω–∏–π –≤–∏–¥ –∏ —Å—Ç—Ä—É–∫—Ç—É—Ä–∞)

3. **–°–ò–õ–¨–ù–´–ï –°–¢–û–†–û–ù–´**
   - –ß—Ç–æ —Å–¥–µ–ª–∞–Ω–æ –æ—Å–æ–±–µ–Ω–Ω–æ —Ö–æ—Ä–æ—à–æ
   - –ò–Ω—Ç–µ—Ä–µ—Å–Ω—ã–µ —Ä–µ—à–µ–Ω–∏—è –∏ –ø–æ–¥—Ö–æ–¥—ã

4. **–†–ï–ö–û–ú–ï–ù–î–ê–¶–ò–ò –ü–û –£–õ–£–ß–®–ï–ù–ò–Æ**
   - –ö–æ–Ω–∫—Ä–µ—Ç–Ω—ã–µ —Å–æ–≤–µ—Ç—ã —Å —É–∫–∞–∑–∞–Ω–∏–µ–º –º–µ—Å—Ç –¥–ª—è —É–ª—É—á—à–µ–Ω–∏—è
   - –í–æ–∑–º–æ–∂–Ω—ã–µ –æ–ø—Ç–∏–º–∏–∑–∞—Ü–∏–∏
   - –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏—è –æ—à–∏–±–æ–∫ (–µ—Å–ª–∏ –µ—Å—Ç—å)

5. **–ò–¢–û–ì–û–í–ê–Ø –û–¶–ï–ù–ö–ê**
   - **–û–±—â–∏–π –±–∞–ª–ª: XX/100**
   - –ó–∞–∫–ª—é—á–∏—Ç–µ–ª—å–Ω—ã–π –≤–µ—Ä–¥–∏–∫—Ç
–ë—É–¥—å —Å–ø—Ä–∞–≤–µ–¥–ª–∏–≤, –Ω–æ —Ç—Ä–µ–±–æ–≤–∞—Ç–µ–ª–µ–Ω. –ü–∏—à–∏ –ø–æ–Ω—è—Ç–Ω–æ –¥–ª—è —Å—Ç—É–¥–µ–Ω—Ç–∞.
"""
    
    try:
        response = openrouter.chat.completions.create(
            model=AI_MODEL,
            messages=[
                {"role": "user", "content": prompt}
            ],
            max_tokens=1500,
            temperature=0.6
        )
        
        return response.choices[0].message.content
        
    except Exception as e:
        return f"‚ùå –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ –ò–ò: {str(e)}\n\n–ü–æ–ø—Ä–æ–±—É–π—Ç–µ –µ—â–µ —Ä–∞–∑ —á–µ—Ä–µ–∑ –Ω–µ—Å–∫–æ–ª—å–∫–æ –º–∏–Ω—É—Ç."


# –ó–∞–ø—É—Å–∫ –±–æ—Ç–∞
async def main():
    print("ü§ñ –ó–∞–ø—É—Å–∫–∞—é –±–æ—Ç –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏ –ª–∞–±–æ—Ä–∞—Ç–æ—Ä–Ω—ã—Ö —Ä–∞–±–æ—Ç...")
    print("üìÑ –ü–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ–º—ã–µ —Ñ–æ—Ä–º–∞—Ç—ã: PDF, DOCX, TXT")
    print(f"ü§ñ –ò–ò –º–æ–¥–µ–ª—å: {AI_MODEL}")
    print("‚ö° –ü—Ä–æ—Å—Ç–æ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ —Ñ–∞–π–ª –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏!")
    print("-" * 50)
    print("-" * 50)
    
    try:
        await dp.start_polling(bot)
    except KeyboardInterrupt:
        print("\n –ë–æ—Ç –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª–µ–º")
    except Exception as e:
        print(f"\n –û—à–∏–±–∫–∞: {e}")

if __name__ == "__main__":
    asyncio.run(main())
